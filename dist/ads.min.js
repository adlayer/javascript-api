
(function(e){function s(e){function t(){}return t.prototype=e,new t}function u(e,t,n){var r=document.getElementsByTagName("head")[0]||document.insertBefore(document.firstChild.firstChild,document.createElement("head")),i=document.createElement("script");return i.onload=t||undefined,i.type="text/javascript",i.src=e,r.appendChild(i),i}function x(){var e=i("./jsonp_request").JsonpRequest,t=i("./img_request").ImgRequest;return{jsonp:e.make,get:e.make,img:t.make}}var t={},n={};n.exports={};var r=n.exports,i=function(e){return r};r.copy=s;var o=function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e};r.merge=o,r.loadscript=u;var a={},f=function(){var e={load:[],click:[],readyStateChange:[]};this.listeners=function(t){return e[t]},this.addListener=function(t,n){return e[t]||(e[t]=[]),e[t].push(n),e[t]},this.on=function(e,t){return this.addListener(e,t)},this.emit=function(t){var n=e[t];if(n&&n.length>0){var r=0;for(r;r<n.length;r++)n[r].call();return n}}};a.EventEmitter=f,r.events=a;var l={parse:function(e){var t="&",n="=",r={};e=e.split(t);for(var i=0;i<e.length;i++){var s=e[i];s=s.split(n);var o=s[0],u=s[1];isNaN(u)||(u=parseInt(u,10)),r[o]=u}return r},stringify:function(e){var t="&",n="=",r=[];for(var i in e)e[i]&&typeof e[i]!="function"&&r.push(i+n+e[i]);return r.join(t)}};r.querystring=l;var c=function(){var e=i("../utils/merge").merge,t=i("../node_modules/querystring").querystring;this.extend=function(t){return e(this,t)}};r.Core=c;var h=function(e){var t=i("./core").Core;t.apply(this,arguments);var n=new Date;this.type="",this.campaign_id="",this.ad_id="",this.space_id="",this.site_id="",this.page_url="",this.date="",this.time="",this.hour="",this.ip="",this.browser="",this.getFullDate=function(){return typeof n=="object"?(n=n.toISOString(),n):n};var r=function(t){t=t.extend(e)}(this)};h.required=["type","campaign_id","space_id","page_url","page_id"],h.track=function(e){return(new h(e)).save()},h.prototype.getDate=function(){return this.getFullDate().split("T")[0]},h.prototype.getTime=function(){return this.getFullDate().split("T")[1]},h.prototype.getHour=function(){return this.time?this.time.split(":")[0]:!1},h.prototype.validate=function(){for(var e=0;e<h.required.length;e++){var t=h.required[e];if(!this[t])return!1}return!0},h.prototype.toQuery=function(){var e=i("../node_modules/querystring").querystring;return e.stringify(this)},h.prototype.save=function(){throw new Error("You should override this")},r.Event=h;var p=function(e){var t=i("./core").Core,n=i("../node_modules/events").events.EventEmitter;t.apply(this,arguments),n.apply(this,arguments),this.id="",this.name="",this.campaign_id="",this.type="",this.file="",this.link="",this.status=!0,this.alternative={};var r=function(t){t=t.extend(e)}(this)};r.Ad=p;var d=function(){this.getAd=function(e){throw new Error("Implement it")}};r.ISpaceBehaviour=d;var v=function(){this.getAd=function(e){var t=e.ads,n=t.length,r=Math.floor(Math.random()*n),i=t[r];return t.splice(r,1),i}},m=function(e){var t=i("./core").Core;t.apply(this,arguments),this.id="",this.type="",this.status="",this.ads=[],this.behaviour={},this.setBehaviour=function(e){return this.behaviour=e,this.behaviour},this.getAd=function(){return this.behaviour.getAd(this)};var n=function(t){t=t.extend(e),t.setBehaviour(new v)}(this)};r.Space=m;var g=function(e){var t=i("./core").Core;t.apply(this,arguments),this.id="",this.name="",this.spaces=[],this.status=!0;var n=function(t){t=t.extend(e)}(this)};g.prototype.getActiveContent=function(){return this.spaces&&this.spaces.length>=1&&(this.spaces=this.spaces.map(function(e){return e.ads&&e.ads.length>=1&&(e.ads=e.ads.filter(function(e){return e.status})),e})),this},r.Page=g;var y=function(e){var t=i("./core").Core;t.apply(this,arguments),this.id="",this.name="",this.status=!0,this.domains=[];var n=function(t){t=t.extend(e)}(this)};y.prototype.hasDomain=function(e){function r(e,t){return t.indexOf(e)!==-1}var t=this,n=!1;return r(e,this.domains)?n=!0:this.domains.forEach(function(t){var i=r("*",t);i&&(t=t.replace("*",""),r(t,e)&&(n=!0))}),n},r.Site=y;var b=function(){function n(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}var e=i("../domain/core").Core,t=i("../node_modules/querystring").querystring;e.apply(this,arguments),this.host="",this.protocol="http",this.port=80,this.path="",this.qs={},this.query="",this.url="",this.getUrl=function(){return this.url||(this.url=this.protocol,this.url+="://",this.url+=this.host,this.url+=this.path,n(this.qs)||(this.query=[this.query,t.stringify(this.qs)].join("&")),this.query&&(this.url+="?"+this.query)),this.url}};r.Http=b;var w=function(e,t){var n=i("./http").Http;n.apply(this,arguments),this.callback=undefined;var r=function(n){typeof e=="string"?n.url=e:n=n.extend(e),n.callback=t||n.callback}(this)};r.HttpRequest=w;var E=function(){var e=i("./http_request").HttpRequest;e.apply(this,arguments)};E.prototype.send=function(e){e&&(this.qs=e);var t=E.document||document,n=t.createElement("img");return n.src=this.getUrl(),this.callback&&(n.onload=this.callback.apply({ok:!0})),this},E.document=undefined,E.make=function(e,t,n){var r=new E(e,t);return n&&(r.document=n),r.send(),r},r.ImgRequest=E;var S=function(){var e=i("./http_request").HttpRequest;e.apply(this,arguments)};S.prototype.queryCallback=function(e){return this.qs.callback=e,this},S.prototype.validate=function(){return this.qs.callback!==undefined},S.prototype.send=function(e){function t(e,t){var n=t.createElement("script");return n.type="text/javascript",n.src=e,t.getElementsByTagName("head")[0].appendChild(n),n}return e&&(this.qs=e),t(this.getUrl(),S.document||document),this},S.document=undefined,S.make=function(e,t){function n(e){function t(t){t?e(null,t):e(new Error("No Response"),null)}return t}var r=new S(e,n(t));return r.send(),r},r.JsonpRequest=S,r.request=x;var T=function(e){var t=i("../request/http").Http;t.apply(this,arguments),this._index=0,this.name="",this.requests={};var n=function(t){typeof e=="string"?t.url=e:t=t.extend(e)}(this)};T.prototype.id=function(){return"n"+this._index},T.prototype.newId=function(){return this._index++,this.id()},T.prototype.next=function(e){var t=this.newId();this.requests[t]=e},T.prototype.getCallbackPath=function(){return[this.name,"requests",this.id(),"callback"].join(".")},T.prototype.request=i("../request/request").request,T.prototype.get=function(e,t,n){return typeof t=="function"&&(n=t),t.callback=this.getCallbackPath(),this.path=e,this.qs=t,this.requests[this.id()]={},this.request().get(this,n),this.newId(),this},r.Connection=T,function(){function n(){this.connection={}}var e=i("../utils/copy").copy,t=i("../domain/core").Event;n.prototype.track=function(n){var r=new t(n),i=e(this.connection);i.host=i.host,i.path="/"+r.type+"/"+r.ad_id;if(r.validate()){i.qs=r;var s=x().img(i,function(e,t){if(e)throw new Error({message:"impossible to track"})});this.connection.next(s)}},r.Tracker=n}();var N=function(){this.id="",this.element=undefined};N.create=function(e,t){return t.createElement(e)},N.prototype.create=function(t,n){return n=this.document||e.document||n,this.element=N.create(t,n),this.element},N.prototype.setAttributes=function(e){var t=i("../utils/merge").merge;t(this.element,e)},N.prototype.append=function(e){return this.element.appendChild(e),this},N.prototype.findParentTag=function(e){var t=this.element.parentNode;while(t.nodeName!=e)t=t.parentNode;return t},N.prototype.addDomEventListener=function(e,t){return typeof addEventListener=="function"?this.element.addEventListener(e,t,!1):typeof attachEvent=="function"?this.element.attachEvent("on"+e,t):this.element["on"+e]=t,this},r.DomElement=N,function(){var e=i("./dom_element").DomElement,t=i("../domain/ad").Ad,n=i("../domain/event").Event,s=function(){t.apply(this,arguments),this.tracker={}};s.prototype=new e,s.prototype.getSpaceId=function(){var e=this.findParentTag("DIV");return e.id},s.prototype.getClickTag=function(e,t,r){var i=this.tracker.connection.getUrl(),s=new n({type:"click",campaign_id:this.campaign_id,space_id:this.getSpaceId(),site_id:e,page_id:t,page_url:r,link:this.link});if(s.validate()&&this.link){var o=[i,"click",this.id].join("/");return o=o+"?"+s.toQuery(),o}return!1},s.prototype.init=function(e,t){var n=this;return n.on("load",function(){n.tracker.track({type:"impression",site_id:t.site_id,domain:t.domain,page_url:t.page_url,page_id:t.page_id,ad_id:n.id,campaign_id:n.campaign_id,space_id:e.id})}),n.on("placement",function(){var e=n.getClickTag(t.site_id,t.page_id,t.page_url);n.element.href=e}),n},r.AdDom=s}(),function(){var e=i("./dom_element").DomElement,t=i("../domain/space").Space,n=function(){t.apply(this,arguments),this.placements={},this.ad={}};n.prototype=new e,n.prototype.placeAd=function(e){return this.element.appendChild(e.element),e.emit("placement"),this.ad=e,this},n.prototype.getElement=function(){return this.document.getElementById(this.id)},r.SpaceDom=n}();var C=function(){var e=i("../node_modules/querystring").querystring;this.align="center",this.menu=!1,this.quality="high",this.scale="noscale",this.wmode="transparent",this.type="application/x-shockwave-flash",this.allowScriptAccess="always",this.allowNetworking="all",this.getSrc=function(){if(!this.preloader)return this.src;var t=this.preloader+"?"+e.stringify({src:this.src,callback:this.callback,value:this.id});return t}};r.Swf=C,function(){var e=i("../dom/ad_dom").AdDom,t=i("./swf").Swf,n=function(){e.apply(this,arguments),t.apply(this,arguments);var n=function(e){return e.create("EMBED"),e.element.src=e.getSrc(),e.element.setAttribute("height",e.height),e.element.setAttribute("width",e.width),e.element.setAttribute("type",e.type),e.element.setAttribute("allowScriptAccess",e.allowScriptAccess),e.element.setAttribute("allowNetworking",e.allowNetworking),e.element.setAttribute("menu",e.menu),e.element.setAttribute("wmode",e.wmode),e.element.setAttribute("scale",e.scale),e.element.setAttribute("quality",e.quality),e.element.id=e.id,e.element}(this)};n.prototype=new e,r.EmbedAd=n}(),function(){var e=i("../dom/ad_dom").AdDom,t=i("./swf").Swf,n=function(){var n=this;e.apply(this,arguments),t.apply(this,arguments);var r="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",i="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0",s="http://www.macromedia.com/go/getflashplayer",o=function(e,t){return this.name=e,this.value=t,this.element=n.create("param"),this.element.setAttribute("name",this.name),this.element.setAttribute("value",this.value),this.element},u=function(e){e.create("OBJECT"),e.element.src=e.src,e.element.setAttribute("data",e.src),e.element.setAttribute("classid",r),e.element.setAttribute("codebase",i);var t=e.element.cloneNode(!0);return t.appendChild(new o("movie",e.getSrc())),t.appendChild(new o("quality",e.quality)),t.appendChild(new o("src",e.src)),t.appendChild(new o("menu",e.menu)),t.appendChild(new o("scale",e.scale)),t.appendChild(new o("allowScriptAccess",e.allowScriptAccess)),t.appendChild(new o("allowNetworking","all")),t.appendChild(new o("base",e.base)),t.appendChild(new o("wmode",e.wmode)),e.element=t,e.element.id=e.id,e.element}(this)};n.prototype=new e,r.ObjectAd=n}(),function(){var e=i("../dom/ad_dom").AdDom,t=function(){e.apply(this,arguments);var t=function(e){e.create("img"),e.element.src=e.src;var t=e.element;return e.element.id=e.id,e.addDomEventListener("load",function(){e.emit("load")}),e.link&&(e.create("a"),e.element.href=e.link,e.append(t)),e.element.style.height=e.height+"px",e.element.style.width=e.width+"px",e.element.setAttribute("height",e.height),e.element.setAttribute("width",e.width),e.element}(this)};t.prototype=new e,r.ImgAd=t}(),function(){var e=i("./embed_ad.js").EmbedAd,t=i("./object_ad.js").ObjectAd,n=function(n){var r=function(r){return r.browser?new t(n):new e(n)}(this);return r};r.FlashAd=n}(),function(){r.ads=function(){var e=i("./flash_ad.js").EmbedAd,t=i("./img_ad.js").ImgAd;return{create:function(n){n.id=n._id,n.src=n.file,delete n.file,delete n._id;switch(n.type){case"flash":return n.preloader="http://xframe.adlayerjavascriptsdk.com.s3.amazonaws.com/as3.swf",n.callback="adlayer.markAdAsLoaded",new e(n);case"image":return new t(n)}}}}()}(),function(){var e=i("../dom/space_dom").SpaceDom,t=i("../ads/ads").ads,n=function(){e.apply(this,arguments),this.placements={},this.ad={}};n.prototype=new e,n.prototype.init=function(e,n){if(this.ads&&this.ads.length>0){var r=t.create(this.getAd());r.tracker=e,r=r.init(this,n),this.placeAd(r)}return this},r.BasicSpace=n}(),function(){var e=i("./basic_space").BasicSpace,t=function(){e.apply(this,arguments),this.expandEvent="mouseover",this.retreatEvent="mouseout";var t=function(e){e.element=e.element||e.getElement()||e.create("DIV"),e.element.id=e.id,e.element.style.height=e.height,e.element.style.width=e.width,e.element.style.position="absolute",e.addDomEventListener(e.expandEvent,function(){e.expand(),e.state="expanded"}),e.addDomEventListener(e.retreatEvent,function(){e.retract(),e.state="retreated"}),e.retract()}(this)};t.prototype=new e,t.prototype.clip=function(e,t){return this.element.style.clip="rect(0px "+e+" "+t+" 0px)",this},t.prototype.expand=function(){var e=this.element.firstChild;if(e){var t=e.style.width||e.width+"px",n=e.style.height||e.height+"px";return this.clip(t,n),this}},t.prototype.retract=function(){return this.clip(this.width,this.height),this},r.ExpandableSpace=t}(),function(){var e=i("./basic_space").BasicSpace,t=function(){e.apply(this,arguments),this.close=function(){var e=this.element;e.parentNode.removeChild(e),delete this.element};var t=function(e){e.element=e.element||e.getElement()||e.create("DIV"),e.element.id=e.id,e.element.style.height=e.height,e.element.style.width=e.width,e.element.style.position="absolute";var t=e.document.createElement("BUTTON");t.innerHTML="x",t.onclick=function(){e.close()},e.append(t)}(this)};t.prototype=new e,r.FloaterSpace=t}(),function(){var e=i("./basic_space").BasicSpace,t=function(){e.apply(this,arguments);var t=function(e){e.element=e.element||e.getElement()||e.create("DIV"),e.element.style.height=e.height,e.element.style.width=e.width,e.element.id=e.id}(this)};t.prototype=new e,r.StaticSpace=t}(),function(){r.spaces=function(){var e=i("./expandable_space.js").ExpandableSpace,t=i("./floater_space.js").FloaterSpace,n=i("./static_space.js").StaticSpace;return{create:function(r){r.id=r._id,r.width=r.size.width,r.height=r.size.height,delete r._id,delete r.size;switch(r.type){case"expandable":return new e(r);case"floater":return new t(r);case"static":return new n(r)}}}}()}(),r.config={url:{adserver:{host:"jocasta.adlayerapp.com"},tracker:{host:"tracker.adlayerapp.com"}},adsPerSpace:1,page:{autoRun:!0,scriptTagId:"adlayerScript"}},function(){var e=i("../node_modules/events").events.EventEmitter,t=i("../domain/ad").Ad,n=i("./lib/src/ads/ads").ads,o=i("../request/request").request,u=i("../spaces/spaces").spaces,a=function(){t.apply(this,arguments),e.apply(this,arguments),this.document,this.tracker,this.connection,this.spacesCollection={},this.adsCollection={}};a.prototype.getData=function(e){var t=this.connection.id(),n=s(this.connection);n.host=n.host,n.path="/ads/"+this.id,n.qs={callback:"adlayer.connections.adserver.requests."+t+".callback"};var r=o().get(n,e);this.connection.requests[t]=r},a.prototype.init=function(e){var t=this;return this.getData(function(r,i){var s=n.create(i);t.element=s.element,e.call(t)}),this},r.AdApi=a}(),function(e){var t=i("../node_modules/querystring").querystring,n=i("../connection/connection").Connection,r=i("./ad_api").AdApi,s=i("../tracker/tracker").Tracker,o=i("../config/config").config,u=u||e,a=u.adlayer||{},f=a.config||{};f.url=f.url||o.url,f.adsPerSpace=f.adsPerSpace||o.adsPerSpace,f.page=f.page||o.page,a.config=f;var l={adserver:new n(f.url.adserver),tracker:new n(f.url.tracker)},c=new s;c.connection=l.tracker,a.page={},a.config=f,a.connections=l,a.spaces={},a.ads={},a.markAdAsLoaded=function(e){a.ads[e].emit("load")},u.adlayer=a,function(){var n=u.document;e.onload=function(){var e=n.getElementsByClassName("adlayer_ad_placeholder");for(var t=0;t<e.length;t++){var i=e[t],s=i.id,o=n.getElementById(s),u=new r({id:s,tracker:c,connection:l.adserver,document:n});u.init(function(){var e=o.parentNode;e.replaceChild(this.element,o)})}}}()}(this)})(this)